@model PBLC.Web.Models.Entities.Course
@{
    ViewData["Title"] = Model.Name;
}

<div class="container-fluid">
    <!-- Course Header -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h2 class="mb-3">@Model.Name</h2>
                    <p class="text-muted mb-2"><i class="bi bi-code-square"></i> <strong>Code:</strong> @Model.Code</p>
                    <p class="text-muted mb-2"><i class="bi bi-building"></i> <strong>Department:</strong> @Model.Department?.Name</p>
                    <p class="text-muted mb-2"><i class="bi bi-person"></i> <strong>Teacher:</strong> @Model.Teacher?.FullName</p>
                    <p class="mt-3">@Model.Description</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-grid gap-2">
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                            var isEnrolled = Model.EnrolledStudents?.Any(s => s.Id == userId) ?? false;
                            var isTeacher = Model.TeacherId == userId;

                            @if (isTeacher)
                            {
                                <a asp-controller="Lecture" asp-action="Upload" asp-route-courseId="@Model.Id" class="btn btn-primary">
                                    <i class="bi bi-cloud-upload"></i> Upload Lecture
                                </a>
                                <a asp-controller="Assignment" asp-action="Create" asp-route-courseId="@Model.Id" class="btn btn-success">
                                    <i class="bi bi-file-plus"></i> Create Assignment
                                </a>
                            }
                            else if (!isEnrolled)
                            {
                                <form asp-controller="Student" asp-action="EnrollCourse" method="post">
                                    <input type="hidden" name="courseId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-person-plus"></i> Enroll Now
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="badge bg-success p-3">
                                    <i class="bi bi-check-circle"></i> Already Enrolled
                                </span>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Content Tabs -->
    <ul class="nav nav-tabs mb-4" id="courseTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="lectures-tab" data-bs-toggle="tab" data-bs-target="#lectures" type="button">
                <i class="bi bi-play-circle"></i> Lectures
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button">
                <i class="bi bi-file-earmark-text"></i> Assignments
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="qa-tab" data-bs-toggle="tab" data-bs-target="#qa" type="button">
                <i class="bi bi-chat-dots"></i> Q&A Forum
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button">
                <i class="bi bi-people"></i> Students (@Model.EnrolledStudents?.Count)
            </button>
        </li>
    </ul>

    <div class="tab-content" id="courseTabContent">
        <!-- Lectures Tab -->
        <div class="tab-pane fade show active" id="lectures" role="tabpanel">
            @if (Model.Lectures != null && Model.Lectures.Any())
            {
                <div class="list-group">
                    @foreach (var lecture in Model.Lectures.OrderByDescending(l => l.CreatedAt))
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">@lecture.Title</h5>
                                    <p class="mb-1 text-muted">@lecture.Description</p>
                                    <small class="text-muted">Posted: @lecture.CreatedAt.ToString("MMM dd, yyyy")</small>
                                </div>
                                <div>
                                    @if (!string.IsNullOrEmpty(lecture.ContentUrl))
                                    {
                                        <a href="@Url.Action("Download", "Lecture", new { id = lecture.Id })" class="btn btn-sm btn-primary">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                    }
                                    @if (!string.IsNullOrEmpty(lecture.VideoUrl))
                                    {
                                        <a href="@lecture.VideoUrl" class="btn btn-sm btn-success" target="_blank">
                                            <i class="bi bi-play-circle"></i> Watch Video
                                        </a>
                                    }
                                    @{
                                        var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                                        var isTeacher = Model.TeacherId == userId;
                                    }
                                    @if (isTeacher)
                                    {
                                        <form asp-controller="Lecture" asp-action="Delete" method="post" class="d-inline ms-2"
                                              onsubmit="return confirm('Are you sure you want to delete this lecture?');">
                                            <input type="hidden" name="id" value="@lecture.Id" />
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No lectures available yet.
                </div>
            }
        </div>

        <!-- Assignments Tab -->
        <div class="tab-pane fade" id="assignments" role="tabpanel">
            @if (Model.Assignments != null && Model.Assignments.Any())
            {
                <div class="row">
                    @foreach (var assignment in Model.Assignments.OrderByDescending(a => a.CreatedAt))
                    {
                        var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                        var isTeacher = Model.TeacherId == userId;
                        
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">@assignment.Title</h5>
                                    <p class="card-text">@assignment.Description</p>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-calendar"></i> Due: @assignment.DueDate.ToString("MMM dd, yyyy hh:mm tt")
                                    </p>
                                    <p class="text-muted mb-3">
                                        <i class="bi bi-star"></i> Max Marks: @assignment.MaxMarks
                                    </p>
                                    @if (isTeacher)
                                    {
                                        <div class="btn-group" role="group">
                                            <a href="@Url.Action("Submissions", "Assignment", new { assignmentId = assignment.Id })" class="btn btn-primary btn-sm">
                                                <i class="bi bi-list-check"></i> View Submissions
                                            </a>
                                            <a href="@Url.Action("Edit", "Assignment", new { id = assignment.Id })" class="btn btn-warning btn-sm">
                                                <i class="bi bi-pencil"></i> Edit
                                            </a>
                                            <button type="button" class="btn btn-danger btn-sm" 
                                                    onclick="deleteAssignment(@assignment.Id, '@assignment.Title')">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        var hasSubmitted = assignment.Submissions?.Any(s => s.StudentId == userId) ?? false;
                                        @if (hasSubmitted)
                                        {
                                            <span class="badge bg-success">Submitted</span>
                                        }
                                        else
                                        {
                                            <a href="@Url.Action("Submit", "Assignment", new { id = assignment.Id })" class="btn btn-success btn-sm">
                                                <i class="bi bi-upload"></i> Submit Assignment
                                            </a>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No assignments available yet.
                </div>
            }
        </div>

        <!-- Q&A Forum Tab -->
        <div class="tab-pane fade" id="qa" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-chat-dots-fill" style="font-size: 4rem; color: #0d6efd;"></i>
                    <h3 class="mt-3">Discussion Forum</h3>
                    <p class="text-muted">Ask questions, share knowledge, and help each other learn</p>
                    <a href="@Url.Action("Index", "QA", new { courseId = Model.Id })" class="btn btn-primary btn-lg mt-3">
                        <i class="bi bi-chat-dots-fill"></i> Open Q&A Forum
                    </a>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="text-muted">
                                <i class="bi bi-question-circle" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0"><small>Ask Questions</small></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-muted">
                                <i class="bi bi-reply-fill" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0"><small>Get Answers</small></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-muted">
                                <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0"><small>Collaborate</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div class="tab-pane fade" id="students" role="tabpanel">
            @if (Model.EnrolledStudents != null && Model.EnrolledStudents.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Enrolled Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var student in Model.EnrolledStudents)
                            {
                                <tr>
                                    <td>@student.FullName</td>
                                    <td>@student.Email</td>
                                    <td>@student.Faculty?.Name</td>
                                    <td>@student.CreatedAt.ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No students enrolled yet.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function deleteAssignment(assignmentId, assignmentTitle) {
            if (confirm(`Are you sure you want to delete "${assignmentTitle}"?\n\nNote: You cannot delete assignments with existing submissions.`)) {
                // Create a form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("Delete", "Assignment")/' + assignmentId;
                
                // Add anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = token.value;
                    form.appendChild(tokenInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}
